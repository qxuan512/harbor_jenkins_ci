pipeline {
    agent {
        kubernetes {
            yamlFile 'kaniko-builder-harbor.yaml'
        }
    }

    parameters {
        // å…è®¸å¤–éƒ¨ç¨‹åºé€šè¿‡å‚æ•°è§¦å‘æ„å»º
        string(name: 'APP_NAME', defaultValue: 'iot-driver', description: 'åº”ç”¨åç§°')
        string(name: 'APP_VERSION', defaultValue: '1.0.0', description: 'åº”ç”¨ç‰ˆæœ¬')
        string(name: 'BUILD_CONTEXT', defaultValue: 'example_direct_upload', description: 'æ„å»ºä¸Šä¸‹æ–‡ç›®å½•')
        choice(name: 'IMAGE_TAG_STRATEGY', choices: ['version-build', 'timestamp', 'latest'], description: 'é•œåƒæ ‡ç­¾ç­–ç•¥')
    }

    environment {
        // Harbor ä»“åº“é…ç½®
        HARBOR_REGISTRY = "registry.test.shifu.dev"
        HARBOR_PROJECT = "test-project"
        DOCKER_USER = "admin"
        DOCKER_PASS = 'harbor-credentials'  // Jenkins å‡­æ® ID
        
        // é•œåƒé…ç½®
        IMAGE_NAME = "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${params.APP_NAME}"
        IMAGE_TAG = generateImageTag()
        
        // æ„å»ºé…ç½®
        DOCKERFILE_PATH = "${params.BUILD_CONTEXT}/Dockerfile"
        BUILD_CONTEXT_PATH = "${params.BUILD_CONTEXT}"
    }

    stages {
        stage("æ¸…ç†å·¥ä½œç©ºé—´") {
            steps {
                cleanWs()
            }
        }

        stage("è·å–æºä»£ç ") {
            steps {
                script {
                    // ä» SCM æ£€å‡ºä»£ç 
                    git branch: 'master', credentialsId: 'github', url: 'https://github.com/qxuan512/harbor_jenkins_ci.git'
                    
                    echo "âœ… ä»£ç æ£€å‡ºå®Œæˆ"
                    echo "æ„å»ºä¸Šä¸‹æ–‡: ${BUILD_CONTEXT_PATH}"
                    echo "Dockerfile è·¯å¾„: ${DOCKERFILE_PATH}"
                    
                    // éªŒè¯æ„å»ºç›®å½•å’Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
                    sh """
                        if [ ! -d "${BUILD_CONTEXT_PATH}" ]; then
                            echo "âŒ é”™è¯¯: æ„å»ºç›®å½• ${BUILD_CONTEXT_PATH} ä¸å­˜åœ¨"
                            exit 1
                        fi
                        
                        if [ ! -f "${DOCKERFILE_PATH}" ]; then
                            echo "âŒ é”™è¯¯: Dockerfile ${DOCKERFILE_PATH} ä¸å­˜åœ¨"
                            exit 1
                        fi
                        
                        echo "ğŸ“ æ„å»ºç›®å½•å†…å®¹:"
                        ls -la ${BUILD_CONTEXT_PATH}/
                    """
                }
            }
        }

        stage("æ„å»ºå‡†å¤‡") {
            steps {
                script {
                    echo "ğŸ”§ æ„å»ºå‡†å¤‡é˜¶æ®µ"
                    echo "åº”ç”¨åç§°: ${params.APP_NAME}"
                    echo "åº”ç”¨ç‰ˆæœ¬: ${params.APP_VERSION}" 
                    echo "é•œåƒåç§°: ${IMAGE_NAME}"
                    echo "é•œåƒæ ‡ç­¾: ${IMAGE_TAG}"
                    echo "Harbor ä»“åº“: ${HARBOR_REGISTRY}"
                    echo "é¡¹ç›®: ${HARBOR_PROJECT}"
                    
                    // æ˜¾ç¤ºæ„å»ºä¿¡æ¯
                    sh """
                        echo "=== æ„å»ºä¿¡æ¯ ==="
                        echo "æ„å»ºå·: ${BUILD_NUMBER}"
                        echo "æ„å»ºæ—¶é—´: \$(date)"
                        echo "æ„å»ºèŠ‚ç‚¹: \$(hostname)"
                        echo "Jenkins URL: ${JENKINS_URL}"
                    """
                }
            }
        }

        stage("ä½¿ç”¨ Kaniko æ„å»ºå¹¶æ¨é€é•œåƒ") {
            steps {
                container(name: 'kaniko', shell: '/busybox/sh') {
                    sh '''#!/busybox/sh
                        echo "ğŸš€ å¼€å§‹ä½¿ç”¨ Kaniko æ„å»º Docker é•œåƒ"
                        
                        # æ˜¾ç¤º Kaniko ç‰ˆæœ¬
                        /kaniko/executor version
                        
                        # æ˜¾ç¤ºæ„å»ºä¸Šä¸‹æ–‡
                        echo "ğŸ“‚ æ„å»ºä¸Šä¸‹æ–‡å†…å®¹:"
                        ls -la ${BUILD_CONTEXT_PATH}/
                        
                        # æ‰§è¡Œé•œåƒæ„å»ºå’Œæ¨é€
                        echo "ğŸ”¨ å¼€å§‹æ„å»ºé•œåƒ: ${IMAGE_NAME}:${IMAGE_TAG}"
                        
                        /kaniko/executor \\
                            --dockerfile=${DOCKERFILE_PATH} \\
                            --context=${BUILD_CONTEXT_PATH} \\
                            --destination=${IMAGE_NAME}:${IMAGE_TAG} \\
                            --destination=${IMAGE_NAME}:latest \\
                            --cache=true \\
                            --cache-ttl=24h \\
                            --cleanup
                        
                        echo "âœ… é•œåƒæ„å»ºå¹¶æ¨é€å®Œæˆ"
                        echo "ğŸ“¦ æ¨é€çš„é•œåƒ:"
                        echo "   - ${IMAGE_NAME}:${IMAGE_TAG}"
                        echo "   - ${IMAGE_NAME}:latest"
                    '''
                }
            }
        }

        stage("éªŒè¯é•œåƒæ¨é€") {
            steps {
                script {
                    echo "ğŸ” éªŒè¯é•œåƒæ˜¯å¦æˆåŠŸæ¨é€åˆ° Harbor"
                    
                    // è¿™é‡Œå¯ä»¥æ·»åŠ éªŒè¯é€»è¾‘ï¼Œæ¯”å¦‚è°ƒç”¨ Harbor API æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
                    sh """
                        echo "é•œåƒæ¨é€éªŒè¯:"
                        echo "ä»“åº“åœ°å€: ${HARBOR_REGISTRY}"
                        echo "é¡¹ç›®: ${HARBOR_PROJECT}"
                        echo "é•œåƒ: ${params.APP_NAME}:${IMAGE_TAG}"
                        
                        # å¯ä»¥æ·»åŠ  Harbor API è°ƒç”¨æ¥éªŒè¯é•œåƒ
                        # curl -u admin:password ${HARBOR_REGISTRY}/api/v2.0/projects/${HARBOR_PROJECT}/repositories/${params.APP_NAME}/artifacts
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒ"
            }
        }
        success {
            script {
                echo "ğŸ‰ æ„å»ºæˆåŠŸ!"
                echo "ğŸ“¦ é•œåƒå·²æ¨é€åˆ°: ${IMAGE_NAME}:${IMAGE_TAG}"
                
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æˆåŠŸé€šçŸ¥ï¼Œæ¯”å¦‚å‘é€åˆ°ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ç­‰
                // notifySuccess()
            }
        }
        failure {
            script {
                echo "âŒ æ„å»ºå¤±è´¥!"
                
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å¤±è´¥é€šçŸ¥
                // notifyFailure()
            }
        }
    }
}

// ç”Ÿæˆé•œåƒæ ‡ç­¾çš„å‡½æ•°
def generateImageTag() {
    def strategy = params.IMAGE_TAG_STRATEGY ?: 'version-build'
    
    switch(strategy) {
        case 'version-build':
            return "${params.APP_VERSION}-${BUILD_NUMBER}"
        case 'timestamp':
            return "${params.APP_VERSION}-${new Date().format('yyyyMMdd-HHmmss')}"
        case 'latest':
            return 'latest'
        default:
            return "${params.APP_VERSION}-${BUILD_NUMBER}"
    }
} 